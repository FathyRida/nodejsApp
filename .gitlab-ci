stages:
  - build
  - test
  - upload
  - deploy

variables:
  AWS_DEFAULT_REGION: "us-east-1"
  S3_BUCKET_NAME: "my-artifactory-bucket"

# CI Stage
build:
  stage: build
  script:
    - echo "Compiling and building the code..."
    - # Your build commands here
    - export ARTIFACT_VERSION=$(git rev-parse --short HEAD)
    - zip -r "artifact_$ARTIFACT_VERSION.zip" ./build/
  artifacts:
    paths:
      - "artifact_$ARTIFACT_VERSION.zip"
    expire_in: 1 day

# CI Stage
unit_tests:
  stage: test
  script:
    - echo "Running unit tests..."
    - # Your test commands here

# Upload to Artifactory (AWS S3)
upload_to_artifactory:
  stage: upload
  script:
    - export ARTIFACT_VERSION=$(git rev-parse --short HEAD)
    - echo "Uploading artifact version $ARTIFACT_VERSION to S3..."
    - aws s3 cp "artifact_$ARTIFACT_VERSION.zip" s3://$S3_BUCKET_NAME/"artifact_$ARTIFACT_VERSION.zip"
  dependencies:
    - build

# CD Stage
deploy_to_staging:
  stage: deploy
  script:
    - export ARTIFACT_VERSION=$(git rev-parse --short HEAD)
    - echo "Deploying artifact version $ARTIFACT_VERSION to staging environment..."
    - # Your deployment commands here, e.g., Ansible, kubectl, etc.
  only:
    - main

# CD Stage
deploy_to_production:
  stage: deploy
  script:
    - echo "Please specify the artifact version to deploy to production:"
    - input:
        id: artifact_version
        required: true
    - echo "Deploying artifact version $artifact_version to production environment..."
    - # Your deployment commands here
  when: manual
  only:
    - main
  image: docker:stable

