#!/bin/bash

#############################################
# Purge Script with Space Monitoring
#############################################

# Configuration
TARGET_DIR="/apps/"
DAYS_OLD=90
LOGDIR="/var/log/cleanup"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
LOGFILE="$LOGDIR/cleanup_$TIMESTAMP.log"

# Create log directory if needed
mkdir -p "$LOGDIR"

# Function to display and log
log() {
    echo "$1" | tee -a "$LOGFILE"
}

# Function to get disk space usage
get_space() {
    df -h "$TARGET_DIR" | awk 'NR==2 {print $3, $4, $5}'
}

# Log header
log "============================================="
log "  Cleanup Script - $(date)"
log "============================================="
log "Target directory: $TARGET_DIR"
log "Files older than: $DAYS_OLD days"
log ""

# Verify directory exists
if [ ! -d "$TARGET_DIR" ]; then
    log "ERROR: Directory $TARGET_DIR does not exist!"
    exit 1
fi

# Capture space BEFORE cleanup
log "--- DISK SPACE BEFORE CLEANUP ---"
SPACE_BEFORE=$(get_space)
log "Used / Available / Usage%"
log "$SPACE_BEFORE"
log ""

# List files to be deleted
log "--- ANALYZING FILES TO DELETE ---"
TEMP_LIST="$LOGDIR/files_to_delete_$TIMESTAMP.txt"
find "$TARGET_DIR" -mtime +$DAYS_OLD -ls > "$TEMP_LIST"

FILE_COUNT=$(wc -l < "$TEMP_LIST")
log "Number of files/directories found: $FILE_COUNT"

if [ "$FILE_COUNT" -eq 0 ]; then
    log "No files to delete. Script completed."
    exit 0
fi

# Calculate total space to be freed
SPACE_TO_FREE=$(find "$TARGET_DIR" -mtime +$DAYS_OLD -type f -exec du -ch {} + 2>/dev/null | grep total$ | awk '{print $1}')
log "Estimated space to free: $SPACE_TO_FREE"
log ""

# Display sample (first 10 files)
log "--- SAMPLE (first 10 files) ---"
head -10 "$TEMP_LIST" | tee -a "$LOGFILE"
log ""

# Ask for confirmation
read -p "Do you want to proceed with deletion? (y/n): " -n 1 -r
echo ""
echo "$REPLY" >> "$LOGFILE"

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    log "Deletion cancelled by user."
    exit 0
fi

# Deletion with progress
log "--- DELETION IN PROGRESS ---"
log "Start: $(date)"

START_TIME=$(date +%s)

find "$TARGET_DIR" -depth -mtime +$DAYS_OLD -delete 2>&1 | tee -a "$LOGFILE"

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

log "End: $(date)"
log "Duration: $DURATION seconds"
log ""

# Capture space AFTER cleanup
log "--- DISK SPACE AFTER CLEANUP ---"
SPACE_AFTER=$(get_space)
log "Used / Available / Usage%"
log "$SPACE_AFTER"
log ""

# Calculate freed space
USED_BEFORE=$(df "$TARGET_DIR" | awk 'NR==2 {print $3}')
USED_AFTER=$(df "$TARGET_DIR" | awk 'NR==2 {print $3}')
FREED=$((USED_BEFORE - USED_AFTER))
FREED_HUMAN=$(echo "$FREED" | awk '{printf "%.2f GB", $1/1024/1024}')

log "--- SUMMARY ---"
log "Files deleted: $FILE_COUNT"
log "Space freed: $FREED_HUMAN"
log "Full log: $LOGFILE"
log "File list: $TEMP_LIST"
log ""
log "============================================="
log "  Cleanup completed successfully"
log "============================================="

# Final screen output
echo ""
echo "‚úÖ Cleanup completed!"
echo "üìä Space freed: $FREED_HUMAN"
echo "üìù Log: $LOGFILE"
