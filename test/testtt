#!/bin/bash

MODE="$1"
ARG1="$2"
ARG2="$3"

if [[ -z "$MODE" || -z "$ARG1" || -z "$ARG2" ]]; then
  echo "Usage:"
  echo "  $0 scan <source_path> <output.json>"
  echo "  $0 create <input.json> <destination_path>"
  echo "  $0 copy <source_path> <destination_path>"
  exit 1
fi

# -------------------------
# SCAN MODE (folders only)
# -------------------------
scan_folders() {
  SRC="$1"
  OUT="$2"

  if [[ ! -d "$SRC" ]]; then
    echo "Source path not found"
    exit 1
  fi

  echo "[" > "$OUT"
  first=true

  find "$SRC" -type d | while read -r dir; do
    rel="${dir#$SRC/}"

    if [[ "$first" = true ]]; then
      first=false
    else
      echo "," >> "$OUT"
    fi

    echo "  { \"path\": \"$rel\" }" >> "$OUT"
  done

  echo "]" >> "$OUT"
  echo "✅ Scan completed -> $OUT"
}

# -------------------------
# CREATE MODE
# -------------------------
create_folders() {
  JSON="$1"
  DEST="$2"

  if [[ ! -f "$JSON" ]]; then
    echo "JSON file not found"
    exit 1
  fi

  mkdir -p "$DEST"

  grep '"path"' "$JSON" | sed -E 's/.*"path": "(.*)".*/\1/' | while read -r p; do
    mkdir -p "$DEST/$p"
  done

  echo "✅ Folder creation completed in $DEST"
}

# -------------------------
# COPY MODE (no *.log)
# -------------------------
copy_tree() {
  SRC="$1"
  DEST="$2"

  if [[ ! -d "$SRC" ]]; then
    echo "Source path not found"
    exit 1
  fi

  mkdir -p "$DEST"

  rsync -av --exclude='*.log' "$SRC/" "$DEST/"

  echo "✅ Copy completed (without *.log files)"
}

# -------------------------
# MAIN
# -------------------------
case "$MODE" in
  scan)
    scan_folders "$ARG1" "$ARG2"
    ;;
  create)
    create_folders "$ARG1" "$ARG2"
    ;;
  copy)
    copy_tree "$ARG1" "$ARG2"
    ;;
  *)
    echo "Unknown mode: $MODE"
    exit 1
    ;;
esac