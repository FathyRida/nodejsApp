#!/bin/bash

SRC="/applis/shared/data/nfs/ECH/raw_layer"
DST="/data/fra/risk/rt/raw_layer"
LOG="/tmp/raw_layer_ingest_$(date +%Y%m%d_%H%M%S).log"

echo "START $(date)" | tee -a "$LOG"
echo "SRC=$SRC" | tee -a "$LOG"
echo "DST=$DST" | tee -a "$LOG"

cd "$SRC" || exit 1

find . -type f | while read FILE; do

    # remove leading ./
    REL_PATH="${FILE#./}"

    SRC_FILE="$SRC/$REL_PATH"
    DST_FILE="$DST/$REL_PATH"
    DST_DIR="$(dirname "$DST_FILE")"

    echo "--------------------------------" | tee -a "$LOG"
    echo "SRC_FILE=$SRC_FILE" | tee -a "$LOG"
    echo "DST_FILE=$DST_FILE" | tee -a "$LOG"

    # create target directory in HDFS
    hdfs dfs -mkdir -p "$DST_DIR"

    # upload file
    hdfs dfs -put -p -f "$SRC_FILE" "$DST_FILE"

done

echo "END $(date)" | tee -a "$LOG"